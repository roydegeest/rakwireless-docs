(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{411:function(t,e,a){"use strict";a.r(e);var s=a(29),o=Object(s.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"external-mqtt-broker-setup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#external-mqtt-broker-setup"}},[t._v("#")]),t._v(" External MQTT Broker Setup")]),t._v(" "),a("p",[t._v("This section provides the procedure in setting the external MQTT Broker for your Application Setup.")]),t._v(" "),a("h2",{attrs:{id:"preparing-the-raspberry-pi"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#preparing-the-raspberry-pi"}},[t._v("#")]),t._v(" Preparing the Raspberry Pi")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("üìù NOTE:")]),t._v(" "),a("p",[t._v("We are going to use going to use a "),a("strong",[t._v("Raspberry Pi 3B+")]),t._v(" for this tutorial, as the device that is going to be hosting Mosquitto (a popular MQTT broker).")])]),t._v(" "),a("ul",[a("li",[t._v("The following items listed below with its download links for the tools and files needed for this demonstration:\n"),a("ul",[a("li",[a("a",{attrs:{href:"https://www.raspberrypi.org/downloads/raspbian/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Raspbian Buster Lite Image"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.balena.io/etcher/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Balena Etcher Tool"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("PuTTY SSH Client"),a("OutboundLink")],1)])])])]),t._v(" "),a("ol",[a("li",[t._v("Download the Raspbian Buster Lite image and flash it into your SD Card using the Balena Etcher. You can follow the steps provided in the Device Firmware Setup section. Once done, plug the SD card into the "),a("strong",[t._v("Raspberry Pi 3B+")]),t._v(" SD card slot and power it.")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("üìù NOTE:")]),t._v(" "),a("p",[t._v("It is highly recommended to follow the configurations of "),a("a",{attrs:{href:"https://www.raspberrypi.org/documentation/configuration/wireless/headless.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("Raspberry Pi headless"),a("OutboundLink")],1),t._v(".")])]),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[a("p",[t._v("Using the PuTTY SSH client, connect to the Raspberry Pi 3B+ with the following credentials:")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("Username")]),t._v(": pi")]),t._v(" "),a("li",[a("strong",[t._v("Password")]),t._v(": raspberry")])])]),t._v(" "),a("li",[a("p",[t._v("Execute the following command and note the IP address of the interface you will be using to connect to the network. You will need this, as it will be the address for your MQTT Broker when configuring the Gateway:")])])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ifconfig")]),t._v("\n")])])]),a("rk-img",{attrs:{src:"/assets/images/deployment-guide/rak-gateway-mesh/rpi-interfaces.jpg",width:"75%","figure-number":"1",caption:"Raspberry Pi interfaces"}}),t._v(" "),a("h2",{attrs:{id:"installing-mosquitto"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#installing-mosquitto"}},[t._v("#")]),t._v(" Installing Mosquitto")]),t._v(" "),a("ol",[a("li",[t._v("Install the MQTT Broker (Mosquitto) via the command:")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" mosquitto mosquitto-clients\n")])])]),a("rk-img",{attrs:{src:"/assets/images/deployment-guide/rak-gateway-mesh/mqtt-installation.jpg",width:"80%","figure-number":"2",caption:"Mosquitto installation"}}),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("Mosquitto clients help us easily test MQTT through a command line utility. We will use two command windows; one to subscribe to a topic and one to publish a message to it. Those will be explained in detail further in the tutorial.")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("üìù NOTE:")]),t._v(" "),a("p",[t._v("This command is not mandatory, however it is recommended as it creates a mosquitto service that will run the broker on startup.")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" mosquitto.service\n")])])]),a("h2",{attrs:{id:"publish-to-the-mqtt-broker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#publish-to-the-mqtt-broker"}},[t._v("#")]),t._v(" Publish to the MQTT Broker")]),t._v(" "),a("p",[t._v("We will now then configure the Gateway to connect to our external MQTT broker. For the purpose of this example, we are going to use the built-in LoRa¬Æ Server.")]),t._v(" "),a("ol",[a("li",[t._v("First go to the Packet Forwarder Tab and choose Built-in LoRa¬Æ Server as your Protocol:")])]),t._v(" "),a("rk-img",{attrs:{src:"/assets/images/deployment-guide/rak-gateway-mesh/protocol-selection.jpg",width:"100%","figure-number":"3",caption:"Protocol selection"}}),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("Make sure you have the LoRa¬Æ Network Server "),a("strong",[t._v("Enabled")]),t._v(" in the General tab:")])]),t._v(" "),a("rk-img",{attrs:{src:"/assets/images/deployment-guide/rak-gateway-mesh/builtin-server-activation.jpg",width:"100%","figure-number":"4",caption:"Built-in LoRa¬Æ Server activation"}}),t._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[t._v("Add Your Gateway in the Gateway tab if you haven‚Äôt done so already. You can also add multiple gateways depending on your preference.")])]),t._v(" "),a("rk-img",{attrs:{src:"/assets/images/deployment-guide/rak-gateway-mesh/lora-gateway-config.jpg",width:"100%","figure-number":"5",caption:"LoRa¬Æ Server Gateway configuration"}}),t._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[t._v("Finally, go to the "),a("strong",[t._v("Global Integration")]),t._v(" tab and enter the address where you have your Mosquitto instance running in the MQTT Broker Address field leaving the Port with the default "),a("code",[t._v("1883")]),t._v(" value.")])]),t._v(" "),a("rk-img",{attrs:{src:"/assets/images/deployment-guide/rak-gateway-mesh/set-global-integration.jpg",width:"100%","figure-number":"6",caption:"Setting up the Global Integration"}}),t._v(" "),a("p",[t._v("Now that the Gateway parameters are set, we will now register your application in order to be able to send and receive data. We are going to use the "),a("strong",[t._v("RAK811 LPWAN Node")]),t._v(" as an example in the next sub-section.")]),t._v(" "),a("h2",{attrs:{id:"downlink"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#downlink"}},[t._v("#")]),t._v(" Downlink")]),t._v(" "),a("p",[t._v("There is a convenient tool in the Built-in LoRa¬Æ Server for sending a Downlink frame.")]),t._v(" "),a("ol",[a("li",[t._v("You can find it in the Device tab in the LoRa¬Æ Network Server section. You can choose your Type of frame ("),a("strong",[t._v("confirmed/unconfirmed")]),t._v("), the Frame port and the Hex Data shown in the image below:")])]),t._v(" "),a("rk-img",{attrs:{src:"/assets/images/deployment-guide/rak-gateway-mesh/downlink.jpg",width:"100%","figure-number":"7",caption:"LoRa¬Æ Network Server Device Downlink tool"}}),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("Once you schedule a message for downlink it will be displayed in the Live Device Data window. Upon sending the next uplink via the RAK Serial Port Tool you will also see it there, as it needs an uplink frame in order to send the downlink in the RX1 window shown in the image below.")])]),t._v(" "),a("rk-img",{attrs:{src:"/assets/images/deployment-guide/rak-gateway-mesh/rec-downlink-frm.jpg",width:"100%","figure-number":"8",caption:"Received Downlink Frame"}}),t._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[t._v("If you want to test the Gateway downlink via the external MQTT Broker, you need to first create a json file which you will be sensing your data in. Below is what the file formatting structure needs to look like:")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("üìù NOTE:")]),t._v(" "),a("ul",[a("li",[t._v('"'),a("strong",[t._v("confirmed")]),t._v('": '),a("strong",[t._v("true")]),t._v(" ‚Äì This is the LoRa¬Æ frame type. True (confirmed), False (unconfirmed)")]),t._v(" "),a("li",[t._v('"'),a("strong",[t._v("data")]),t._v('": "'),a("strong",[t._v("TEST")]),t._v('" ‚Äì example data to be sent')]),t._v(" "),a("li",[t._v('"'),a("strong",[t._v("fPort")]),t._v('": '),a("strong",[t._v("10")]),t._v(" ‚Äì the Frame Port Number")])])]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"confirmed"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"fPort"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"data"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1001"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("üìù NOTE:")]),t._v(" "),a("p",[t._v("You need to have a "),a("strong",[t._v("Base64")]),t._v(" encoded "),a("strong",[t._v("HEX data")]),t._v(" for the above to work.")])]),t._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[t._v("Create the file, for example with the following command and copy the data in discussed above:")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nano")]),t._v(" test.json\n")])])]),a("ol",{attrs:{start:"5"}},[a("li",[t._v("After you have created the file, you need to schedule it for downlink. This means that you have to publish it via Mosquitto with the command:")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" mosquito_pub application/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("application_ID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("/device/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("device_EUI"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/ tx ‚Äìf test.json\n")])])]),a("ul",[a("li",[t._v("The packet will be scheduled for downlink, which you can see in the Gateway Packet logger.")]),t._v(" "),a("li",[t._v("When the next uplink frame that comes for the Application/Device specified by the "),a("strong",[t._v("application_ID")]),t._v(" and "),a("strong",[t._v("device_EUI")]),t._v(" is received, the Gateway will send the data in the RX1 window to the node. You should have a response similar to the one in "),a("strong",[t._v("Figure 8")]),t._v(".")])])],1)}),[],!1,null,null,null);e.default=o.exports}}]);